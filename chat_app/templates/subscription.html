{% extends "base.html" %}

{% block title %}订阅服务 - AI Chat{% endblock %}

{% block content %}
<script>
    // 添加页面特定类
    document.body.classList.add('subscription-page');
</script>
<div class="subscription-container">
    <div class="subscription-header">
        <h2>订阅服务</h2>
        {% if subscription and subscription.is_active() and subscription.plan_type in SUBSCRIPTION_PLANS %}
            <div class="current-subscription">
                <!-- 添加调试信息 -->
                <!-- 
                subscription: {{ subscription }}
                is_active: {{ subscription.is_active() }}
                plan_type: {{ subscription.plan_type }}
                available_plans: {{ SUBSCRIPTION_PLANS.keys()|list }}
                -->
                <p>当前订阅: {{ SUBSCRIPTION_PLANS[subscription.plan_type]['name'] }}</p>
                <p>当前积分: {{ subscription.points }}</p>
                <p>到期时间: {{ subscription.end_date.strftime('%Y-%m-%d') }}</p>
            </div>
        {% else %}
            <div class="current-subscription">
                <!-- 添加调试信息 -->
                <!-- 
                subscription: {{ subscription }}
                is_active: {{ subscription.is_active() if subscription else None }}
                plan_type: {{ subscription.plan_type if subscription else None }}
                -->
                <p>当前为免费用户</p>
                <p>剩余积分: {{ subscription.points if subscription else 0 }}</p>
            </div>
        {% endif %}
    </div>

    <div class="subscription-plans">
        {% for plan_id, plan in plans.items() %}
        <div class="plan-card">
            <h3>{{ plan.name }}</h3>
            <div class="price">${{ plan.price }}(美元)/{{ plan.period }}</div>
            <div class="points">{{ plan.points }} 积分</div>
            <button onclick="createCheckoutSession('{{ plan_id }}')" class="subscribe-btn">
                立即订阅
            </button>
        </div>
        {% endfor %}
    </div>
</div>

{% block scripts %}
<script>
async function subscribe(planType) {
    try {
        const response = await fetch('/create_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ plan_type: planType })
        });
        
        const data = await response.json();
        if (data.payment_url) {
            window.location.href = data.payment_url;
        } else {
            alert('创建订单失败: ' + (data.error || '未知错误'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('订阅失败: ' + error.message);
    }
}
function createCheckoutSession(planType) {
    fetch('/create_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ plan_type: planType })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            window.location.href = data.payment_url;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('发生错误,请重试');
    });
}
</script>
{% endblock %}
{% endblock %}